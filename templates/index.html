<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 10px; overflow-x: hidden; }
        .game-container { width: 100%; max-width: 500px; margin: 0 auto; }
        
        /* Холст теперь имеет динамический фон */
        canvas { background: #222; width: 100%; height: 110px; border-radius: 12px; margin-top: 5px; border: 1px solid #444; transition: background 0.2s; }
        
        .admin-panel { background: #2a2a2a; padding: 15px; border-radius: 18px; margin-top: 10px; border: 2px solid #ffcc00; text-align: left; font-size: 0.85rem; }
        .row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; gap: 8px; }
        
        .input-small { width: 55px; background: #333; color: #ffcc00; border: 1px solid #555; padding: 4px; border-radius: 6px; text-align: center; }
        .color-picker { width: 40px; height: 30px; border: none; padding: 0; background: none; cursor: pointer; }
        
        input[type=range] { flex-grow: 1; }
        
        .btn { width: 100%; padding: 18px; font-size: 1.2rem; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #master-btn { background: #ffcc00; color: black; }
        #player-btn { background: #007bff; color: white; height: 30vh; max-height: 250px; font-size: 2rem; }
        
        .hidden { display: none !important; }
        #status { font-size: 1.3rem; height: 35px; margin: 5px 0; font-weight: bold; }
        .label-text { color: #aaa; font-size: 0.75rem; }
    </style>
</head>
<body>

    <div id="role-setup" style="margin-top: 25vh;">
        <button class="btn" style="background:#ffcc00" onclick="setRole('master')">МАСТЕР</button>
        <button class="btn" style="background:#007bff; color:white; margin-top:20px;" onclick="setRole('player')">ИГРОК</button>
    </div>

    <div id="game-ui" class="game-container hidden">
        <div id="status">ОЖИДАНИЕ...</div>
        <canvas id="gameCanvas"></canvas>

        <div id="master-view" class="hidden">
            <div class="admin-panel">
                <div class="row">
                    <span>Скорость: <input type="number" id="speed-num" class="input-small" value="7" oninput="sync(true)"></span>
                    <input type="range" id="speed-range" min="3" max="60" value="7" oninput="sync(false)">
                </div>
                <div class="row">
                    <span>Отскок: <input type="checkbox" id="bounce-mode" onchange="sync(true)"></span>
                    <span>Край (Fail): <input type="checkbox" id="edge-check" checked onchange="sync(true)"></span>
                </div>
                <div class="row">
                    <span>Цвет полоски: <input type="color" id="color-bar" value="#ffffff" class="color-picker" oninput="sync(true)"></span>
                    <span>Цвет фона: <input type="color" id="color-bg" value="#222222" class="color-picker" oninput="sync(true)"></span>
                </div>
                <div class="row">
                    <span class="label-text">Мин: <input type="number" id="min-limit" class="input-small" value="3" oninput="sync(true)"></span>
                    <span class="label-text">Макс: <input type="number" id="max-limit" class="input-small" value="60" oninput="sync(true)"></span>
                    <span class="label-text">Зона %: <input type="number" id="target-w" class="input-small" value="18" oninput="sync(true)"></span>
                </div>
            </div>
            <button id="master-btn" class="btn" onclick="socket.emit('master_start')">ПУСК</button>
        </div>

        <div id="player-view" class="hidden">
            <button id="player-btn" class="btn">ЖМИ!</button>
        </div>
    </div>

    <script>
        const socket = io();
        const tg = window.Telegram.WebApp;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let role = '', isPlaying = false, barX = 0, targetX = 100, direction = 1;
        let config = { 
            speed: 7, bounce_mode: false, color_bar: "#ffffff", color_bg: "#222222", 
            target_width: 18, fail_on_edge: true, min_limit: 3, max_limit: 60 
        };

        tg.expand();

        function setRole(r) {
            role = r;
            document.getElementById('role-setup').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            if (role === 'master') document.getElementById('master-view').classList.remove('hidden');
            else document.getElementById('player-view').classList.remove('hidden');
            resize();
        }

        function resize() { canvas.width = canvas.offsetWidth; canvas.height = 110; }

        function sync(fromInputs) {
            if (role !== 'master') return;
            const minL = parseInt(document.getElementById('min-limit').value) || 1;
            const maxL = parseInt(document.getElementById('max-limit').value) || 100;
            const num = document.getElementById('speed-num');
            const range = document.getElementById('speed-range');

            range.min = minL; range.max = maxL;
            if (fromInputs) { config.speed = parseInt(num.value); range.value = config.speed; }
            else { config.speed = parseInt(range.value); num.value = config.speed; }

            config.min_limit = minL;
            config.max_limit = maxL;
            config.bounce_mode = document.getElementById('bounce-mode').checked;
            config.fail_on_edge = document.getElementById('edge-check').checked;
            config.color_bar = document.getElementById('color-bar').value;
            config.color_bg = document.getElementById('color-bg').value;
            config.target_width = parseInt(document.getElementById('target-w').value) || 15;

            socket.emit('update_settings', config);
        }

        socket.on('settings_changed', (data) => {
            config = data;
            canvas.style.backgroundColor = data.color_bg; // Мгновенная смена фона
            if (role === 'master') {
                document.getElementById('color-bar').value = data.color_bar;
                document.getElementById('color-bg').value = data.color_bg;
                document.getElementById('bounce-mode').checked = data.bounce_mode;
            }
        });

        socket.on('start_level', (data) => {
            config = data;
            barX = 0; direction = 1; isPlaying = true;
            document.getElementById('status').innerText = "ИГРАЕМ!";
            document.getElementById('status').style.color = "white";
            const tw = canvas.width * (config.target_width / 100);
            targetX = Math.random() * (canvas.width - tw);
        });

        function handlePress() {
            if (!isPlaying) return;
            isPlaying = false;
            const tw = canvas.width * (config.target_width / 100);
            const hit = barX >= targetX && barX <= (targetX + tw);
            socket.emit('player_press', { success: hit });
        }

        const pBtn = document.getElementById('player-btn');
        pBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handlePress(); });
        pBtn.addEventListener('mousedown', handlePress);

        socket.on('show_result', (data) => {
            isPlaying = false;
            document.getElementById('status').innerText = data.success ? "ПОПАЛ! ✅" : "ПРОМАХ! ❌";
            document.getElementById('status').style.color = data.success ? "#00ff78" : "#ff3c3c";
            tg.HapticFeedback.notificationOccurred(data.success ? 'success' : 'error');
        });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const tw = canvas.width * (config.target_width / 100);
            
            // Зона
            ctx.fillStyle = "#00ff78";
            ctx.globalAlpha = 0.7;
            ctx.fillRect(targetX, 0, tw, canvas.height);
            ctx.globalAlpha = 1.0;

            if (isPlaying) {
                barX += (config.speed * direction) * (canvas.width / 600);

                if (config.bounce_mode) {
                    // Логика отскока
                    if (barX + 8 > canvas.width || barX < 0) {
                        direction *= -1;
                        tg.HapticFeedback.impactOccurred('light'); // Вибрация при ударе о стенку
                    }
                } else {
                    // Обычная логика (проигрыш у края или круг)
                    if (barX > canvas.width) {
                        if (config.fail_on_edge) {
                            isPlaying = false;
                            if (role === 'player') socket.emit('player_press', { success: false });
                        } else { barX = 0; }
                    }
                }
            }
            
            // Полоска
            ctx.fillStyle = config.color_bar;
            ctx.shadowBlur = 10;
            ctx.shadowColor = config.color_bar;
            ctx.fillRect(barX, 0, 8, canvas.height);
            ctx.shadowBlur = 0;

            requestAnimationFrame(draw);
        }
        draw();
    </script>
</body>
</html>
